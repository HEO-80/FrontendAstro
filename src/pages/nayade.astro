---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <div class="nayade-page">
    <div class="cursor"></div>

    <footer>
      <div class="links">
        <a href="#">Placeholder</a>
        <a href="#">Placeholder</a>
        <a href="#">Placeholder</a>
      </div>
      <p>© 2025 Nayade Recomends go watch the anime and read the manga.</p>
    </footer>

    <div class="container">
      <div class="gallery"></div>
    </div>
  </div>
</Layout>

<script>
import { gems } from '../data/nayade/gems.js';
import gsap from 'gsap';

console.log("Script cargado");

function initGallery() {
  console.log("initGallery ejecutándose");
  
  document.body.classList.add('nayade-body');
  
  const cursor = document.querySelector(".nayade-page .cursor");
  const gallery = document.querySelector(".nayade-page .gallery");

  if (!gallery || !cursor) {
    console.error("No se encontraron los elementos necesarios");
    return;
  }

  const numberOfItems = gems.length;
  const radius = 800;
  const angleIncrement = (2 * Math.PI) / numberOfItems;
  
  // Función para obtener centro actual con ajuste responsive
  const getCenter = () => {
    const width = window.innerWidth;
    let xOffset = 0;
    
    // Ajustar el offset según el ancho de pantalla
    if (width > 1400) {
      xOffset = width * 0.05; // 5% hacia la derecha en pantallas grandes
    } else if (width < 768) {
      xOffset = -width * 0.1; // 10% hacia la izquierda en móviles
    }
    
    return {
      x: width / 2 + xOffset,
      y: window.innerHeight / 2
    };
  };

  let center = getCenter();

  console.log("Configuración:", { numberOfItems, radius, centerX: center.x, centerY: center.y });

  for (let i = 0; i < numberOfItems; i++) {
    const item = document.createElement("div");
    item.className = "item";
    const p = document.createElement("p");
    const count = document.createElement("span");
    p.textContent = gems[i].name;
    count.textContent = `(${gems[i].hardness})`;
    item.appendChild(p);
    p.appendChild(count);
    gallery.appendChild(item);

    const angle = i * angleIncrement;
    const x = center.x + radius * Math.cos(angle);
    const y = center.y + radius * Math.sin(angle);
    const rotation = (angle * 180) / Math.PI;

    gsap.set(item, {
      x: x,
      y: y,
      rotation: rotation,
    });

    item.addEventListener("mouseover", () => {
      const imgSrc = `/nayade/img${i + 1}.webp`;
      const img = document.createElement("img");
      img.src = imgSrc;
      img.className = "cursor-img";
      img.style.clipPath = "polygon( 0 100%, 100% 100%, 100% 100%, 0 100% )";
      
      cursor.appendChild(img);

      gsap.to(img, {
        clipPath: "polygon( 0 100%, 100% 100%, 100% 0%, 0 0% )",
        duration: 1,
        ease: "power3.out",
      });
    });

    item.addEventListener("mouseout", () => {
      const imgs = cursor.querySelectorAll(".cursor-img");
      if (imgs.length > 0) {
        const lastImg = imgs[imgs.length - 1];
        Array.from(imgs).forEach((img) => {
          if (img !== lastImg) {
            gsap.to(img, {
              clipPath: "polygon( 0 0%, 100% 0%, 100% 0%, 0 0% )",
              duration: 1,
              ease: "power3.out",
              onComplete: () => img.remove(),
            });
          }
        });

        gsap.to(lastImg, {
          clipPath: "polygon( 0 0%, 100% 0%, 100% 0%, 0 0% )",
          duration: 1,
          ease: "power3.out",
          delay: 0.25,
          onComplete: () => lastImg.remove(),
        });
      }
    });
  }

  console.log("Total items creados:", gallery.children.length);

  function updatePosition() {
    center = getCenter(); // Actualizar centro en cada frame
    const scrollAmount = window.scrollY * 0.001;
    document.querySelectorAll(".nayade-page .item").forEach((item, index) => {
      const angle = index * angleIncrement + scrollAmount;
      const x = center.x + radius * Math.cos(angle);
      const y = center.y + radius * Math.sin(angle);
      const rotation = (angle * 180) / Math.PI;

      gsap.to(item, {
        duration: 0.03,
        x: x,
        y: y,
        rotation: rotation,
        ease: "power2.out",
      });
    });
  }

  updatePosition();
  document.addEventListener("scroll", updatePosition);

  // Resize handler con debounce
  let resizeTimeout: ReturnType<typeof setTimeout> | null = null;
  window.addEventListener("resize", () => {
    if (resizeTimeout) clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(updatePosition, 100);
  });

  document.addEventListener("mousemove", (e) => {
    gsap.to(cursor, {
      x: e.clientX - 150,
      y: e.clientY - 200,
      duration: 0.1,
      ease: "power3.out",
    });
  });
}

// Probar múltiples eventos
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initGallery);
} else {
  initGallery();
}

document.addEventListener("astro:page-load", initGallery);
</script>

<style is:global>
  /* Estilos para body solo cuando es la página de nayade */
  body.nayade-body {
    background: #000;
    font-family: "Circular Std", sans-serif;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
  }

  /* Ocultar scrollbar en todos los navegadores */
  body.nayade-body::-webkit-scrollbar {
    display: none;
  }

  body.nayade-body {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  /* Contenedor principal de la página */
  .nayade-page {
    width: 100%;
    min-height: 3000vh;
    background: #000;
    position: relative;
    overflow-x: hidden;
  }

  /* Estilos específicos para elementos de nayade */
  .nayade-page .cursor-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .nayade-page .cursor {
    position: fixed;
    top: 0;
    left: 0;
    width: 300px;
    height: 400px;
    z-index: 0;
    pointer-events: none;
  }

  .nayade-page footer {
    position: fixed;
    width: 100%;
    padding: 2em;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 2;
    mix-blend-mode: difference;
    bottom: 0;
  }

  .nayade-page footer a,
  .nayade-page footer p {
    text-decoration: none;
    color: #fff;
    font-size: 14px;
  }

  .nayade-page .links {
    display: flex;
    gap: 2em;
  }

  .nayade-page .gallery {
    position: fixed;
    width: 200%;
    height: 100%;
    left: -75%;
    overflow: hidden;
    top: 0;
  }

  .nayade-page .item {
    position: absolute;
    top: 0;
    left: 0;
    transform: translate(-50%, -50%);
    width: 800px;
    height: 80px;
    cursor: pointer;
  }

  .nayade-page .item p {
    width: 100%;
    font-size: 42px;
    font-weight: 500;
    text-transform: uppercase;
    color: #fff;
    margin: 0;
    line-height: 1;
  }

  .nayade-page .item p span {
    padding: 0 20px;
    font-size: 16px;
  }
</style>
